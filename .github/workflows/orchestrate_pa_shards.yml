name: Orchestrate Princess Auto shards (1→35)

on:
  schedule:
    - cron: "0 20 * * 5"     # exemple: vendredi 15:00 Québec en hiver (UTC-5) => 20:00 UTC
  workflow_dispatch:
    inputs:
      reset:
        description: "Reset sequence to shard 01"
        required: false
        type: boolean
        default: false
  workflow_run:
    workflows: ["Princess Auto - Shard Runner"]
    types:
      - completed

permissions:
  contents: write
  actions: write

concurrency:
  group: pa-orchestrator
  cancel-in-progress: false

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync branch
        run: |
          git pull --rebase origin "${{ github.ref_name }}" || true

      - name: Determine next shard (1→35)
        id: calc
        env:
          STATE_PATH: public/princessauto/_orchestrator_state.json
          TOTAL_SHARDS: "35"
          RESET: ${{ github.event_name == 'workflow_dispatch' && inputs.reset }}
        run: |
          node <<'NODE'
          const fs = require("fs");
          const path = require("path");
          const statePath = process.env.STATE_PATH;
          const total = parseInt(process.env.TOTAL_SHARDS, 10);
          const reset = String(process.env.RESET).toLowerCase() === "true";

          let nextShard = 1; // défaut: shard 1
          if (!reset && fs.existsSync(statePath)) {
            try {
              const s = JSON.parse(fs.readFileSync(statePath, "utf8"));
              if (Number.isInteger(s.nextShard) && s.nextShard >= 1 && s.nextShard <= total) {
                nextShard = s.nextShard;
              }
            } catch (e) {}
          }

          const newNext = (nextShard === total) ? 1 : (nextShard + 1);

          const updated = { nextShard: newNext, updatedAt: new Date().toISOString() };
          fs.mkdirSync(path.dirname(statePath), { recursive: true });
          fs.writeFileSync(statePath, JSON.stringify(updated, null, 2));

          console.log(`workflow_file=pa_shard_runner.yml`);
          console.log(`trigger_shard=${nextShard}`);
          console.log(`next_shard=${newNext}`);

          fs.appendFileSync(process.env.GITHUB_OUTPUT, `workflow_file=pa_shard_runner.yml\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `trigger_shard=${nextShard}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `next_shard=${newNext}\n`);
          NODE

      - name: Debug orchestrator state
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "workflow_run.name=${{ github.event.workflow_run.name }}"
            echo "workflow_run.conclusion=${{ github.event.workflow_run.conclusion }}"
            echo "workflow_run.head_branch=${{ github.event.workflow_run.head_branch }}"
          fi
          echo "workflow_file=${{ steps.calc.outputs.workflow_file }}"
          echo "trigger_shard=${{ steps.calc.outputs.trigger_shard }}"
          echo "next_shard=${{ steps.calc.outputs.next_shard }}"
          echo "state file:"
          cat public/princessauto/_orchestrator_state.json

      - name: Trigger shard workflow
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          echo "Triggering shard ${{ steps.calc.outputs.trigger_shard }} => ${{ steps.calc.outputs.workflow_file }}"
          gh workflow run "${{ steps.calc.outputs.workflow_file }}" \
            --repo "$REPO" \
            --ref "${{ github.ref_name }}" \
            -f shard="${{ steps.calc.outputs.trigger_shard }}"

      - name: Commit orchestrator state
        run: |
          git add public/princessauto/_orchestrator_state.json
          git commit -m "PA orchestrator: next shard ${{ steps.calc.outputs.next_shard }}" || echo "Nothing to commit"
          git push origin HEAD:"${{ github.ref_name }}"
