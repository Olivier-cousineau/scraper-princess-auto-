- name: Run shards sequentially (1→35)
  env:
    GH_TOKEN: ${{ github.token }}
    REPO: ${{ github.repository }}
    REF: ${{ github.ref_name }}
    START: ${{ inputs.start || '1' }}
    END: ${{ inputs.end || '35' }}
  run: |
    set -euo pipefail

    start="$START"
    end="$END"

    echo "Running shards sequentially: $start → $end on ref=$REF"

    for shard in $(seq "$start" "$end"); do
      shard2=$(printf "%02d" "$shard")
      echo "=============================="
      echo "Trigger shard $shard2"
      echo "=============================="

      # 1) Trigger the workflow (no --json/-q here)
      gh workflow run "pa_shard_runner.yml" \
        --repo "$REPO" \
        --ref "$REF" \
        -f shard="$shard"

      # 2) Give GitHub a moment to register the run
      sleep 5

      # 3) Get the latest run id for this workflow on this branch
      run_id=$(gh run list \
        --repo "$REPO" \
        --workflow "pa_shard_runner.yml" \
        --branch "$REF" \
        --limit 1 \
        --json databaseId \
        --jq '.[0].databaseId')

      echo "Watching run_id=$run_id for shard $shard2..."

      # 4) Wait for completion and fail if it fails
      gh run watch --repo "$REPO" --exit-status "$run_id"

      echo "Shard $shard2 completed successfully."
    done

    echo "All shards completed successfully."
