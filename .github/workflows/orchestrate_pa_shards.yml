name: Orchestrate Princess Auto shards (35→1)

on:
  schedule:
    - cron: "0 20 * * 5"     # exemple: vendredi 15:00 Québec en hiver (UTC-5) => 20:00 UTC
  workflow_dispatch:
  workflow_run:
    workflows:
      - "Scrape Princess Auto - Shard 01/35"
      - "Scrape Princess Auto - Shard 02/35"
      - "Scrape Princess Auto - Shard 03/35"
      - "Scrape Princess Auto - Shard 04/35"
      - "Scrape Princess Auto - Shard 05/35"
      - "Scrape Princess Auto - Shard 06/35"
      - "Scrape Princess Auto - Shard 07/35"
      - "Scrape Princess Auto - Shard 08/35"
      - "Scrape Princess Auto - Shard 09/35"
      - "Scrape Princess Auto - Shard 10/35"
      - "Scrape Princess Auto - Shard 11/35"
      - "Scrape Princess Auto - Shard 12/35"
      - "Scrape Princess Auto - Shard 13/35"
      - "Scrape Princess Auto - Shard 14/35"
      - "Scrape Princess Auto - Shard 15/35"
      - "Scrape Princess Auto - Shard 16/35"
      - "Scrape Princess Auto - Shard 17/35"
      - "Scrape Princess Auto - Shard 18/35"
      - "Scrape Princess Auto - Shard 19/35"
      - "Scrape Princess Auto - Shard 20/35"
      - "Scrape Princess Auto - Shard 21/35"
      - "Scrape Princess Auto - Shard 22/35"
      - "Scrape Princess Auto - Shard 23/35"
      - "Scrape Princess Auto - Shard 24/35"
      - "Scrape Princess Auto - Shard 25/35"
      - "Scrape Princess Auto - Shard 26/35"
      - "Scrape Princess Auto - Shard 27/35"
      - "Scrape Princess Auto - Shard 28/35"
      - "Scrape Princess Auto - Shard 29/35"
      - "Scrape Princess Auto - Shard 30/35"
      - "Scrape Princess Auto - Shard 31/35"
      - "Scrape Princess Auto - Shard 32/35"
      - "Scrape Princess Auto - Shard 33/35"
      - "Scrape Princess Auto - Shard 34/35"
      - "Scrape Princess Auto - Shard 35/35"
    types: [completed]

permissions:
  contents: write
  actions: write

concurrency:
  group: pa-orchestrator
  cancel-in-progress: false

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion != 'cancelled' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine next shard (35→1)
        id: calc
        env:
          STATE_PATH: public/princessauto/_orchestrator_state.json
          TOTAL_SHARDS: "35"
        run: |
          node <<'NODE'
          const fs = require("fs");
          const statePath = process.env.STATE_PATH;
          const total = parseInt(process.env.TOTAL_SHARDS, 10);

          let nextShard = total; // défaut 35
          if (fs.existsSync(statePath)) {
            try {
              const s = JSON.parse(fs.readFileSync(statePath, "utf8"));
              if (Number.isInteger(s.nextShard) && s.nextShard >= 1 && s.nextShard <= total) {
                nextShard = s.nextShard;
              }
            } catch (e) {}
          }

          const workflowFile = `pa_shard_${String(nextShard).padStart(2,"0")}.yml`;

          // calc du prochain : 35→34→...→1→35
          const newNext = (nextShard === 1) ? total : (nextShard - 1);

          const updated = { nextShard: newNext, updatedAt: new Date().toISOString() };
          fs.mkdirSync(require("path").dirname(statePath), { recursive: true });
          fs.writeFileSync(statePath, JSON.stringify(updated, null, 2));

          // outputs
          console.log(`workflow_file=${workflowFile}`);
          console.log(`trigger_shard=${nextShard}`);
          console.log(`next_shard=${newNext}`);

          fs.appendFileSync(process.env.GITHUB_OUTPUT, `workflow_file=${workflowFile}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `trigger_shard=${nextShard}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `next_shard=${newNext}\n`);
          NODE

      - name: Debug orchestrator state
        run: |
          echo "workflow_file=${{ steps.calc.outputs.workflow_file }}"
          echo "trigger_shard=${{ steps.calc.outputs.trigger_shard }}"
          echo "next_shard=${{ steps.calc.outputs.next_shard }}"
          echo "state file:"
          cat public/princessauto/_orchestrator_state.json

      - name: Trigger shard workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "Triggering shard ${{ steps.calc.outputs.trigger_shard }} => ${{ steps.calc.outputs.workflow_file }}"
          gh workflow run "${{ steps.calc.outputs.workflow_file }}" --repo "$REPO" --ref "${{ github.ref_name }}"

      - name: Commit orchestrator state
        run: |
          git add public/princessauto/_orchestrator_state.json
          git commit -m "PA orchestrator: next shard ${{ steps.calc.outputs.next_shard }}" || echo "Nothing to commit"
          git pull --rebase origin "${{ github.ref_name }}" || true
          git push origin HEAD:"${{ github.ref_name }}"
