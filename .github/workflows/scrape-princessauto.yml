name: Scraper Princess Auto

on:
  workflow_dispatch:
    inputs:
      shard_total:
        description: "Nombre total de shards (>=1)"
        required: true
        default: "1"
      shard_index:
        description: "Indice (0-based) d'un shard spécifique à exécuter. Laisser vide pour tous."
        required: false
        default: ""

jobs:
  determine-shards:
    name: Préparer le sharding
    runs-on: ubuntu-latest
    outputs:
      shard_json: ${{ steps.build.outputs.shards }}
      shard_total: ${{ steps.build.outputs.shard_total }}
    steps:
      - name: Calculer les shards
        id: build
        env:
          SHARD_TOTAL_INPUT: ${{ github.event.inputs.shard_total }}
          SHARD_INDEX_INPUT: ${{ github.event.inputs.shard_index }}
        run: |
          set -euo pipefail

          shard_total=${SHARD_TOTAL_INPUT:-1}

          if ! [[ "$shard_total" =~ ^[0-9]+$ ]] || [ "$shard_total" -lt 1 ]; then
            echo "Invalid shard_total: $shard_total" >&2
            exit 1
          fi

          if [ -n "$SHARD_INDEX_INPUT" ]; then
            shard_index=$SHARD_INDEX_INPUT
            if ! [[ "$shard_index" =~ ^[0-9]+$ ]] || [ "$shard_index" -ge "$shard_total" ]; then
              echo "Invalid shard_index: $shard_index (total: $shard_total)" >&2
              exit 1
            fi
            shards="[$shard_index]"
          else
            shards=$(node - <<'NODE'
const total = Number(process.env.SHARD_TOTAL || 1);
const values = Array.from({ length: total }, (_, idx) => idx);
process.stdout.write(JSON.stringify(values));
NODE
)
          fi

          echo "shard_total=$shard_total" >> "$GITHUB_OUTPUT"
          echo "shards=$shards" >> "$GITHUB_OUTPUT"

  scrape:
    name: Scraper (shard ${{ matrix.shard }})
    needs: determine-shards
    runs-on: ubuntu-latest
    strategy:
      matrix:
        shard: ${{ fromJson(needs.determine-shards.outputs.shard_json) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Installer les dépendances
        run: |
          npm ci || npm install
          npx playwright install --with-deps chromium

      - name: Lancer le scraper
        env:
          SHARD_TOTAL: ${{ needs.determine-shards.outputs.shard_total }}
          SHARD_INDEX: ${{ matrix.shard }}
        run: npm run scrape

      - name: Archiver les résultats
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: outputs-shard-${{ matrix.shard }}
          path: outputs/princessauto
          if-no-files-found: warn
